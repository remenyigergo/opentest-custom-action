package opentest.extension.sample;

import java.time.LocalDate;
import java.time.Period;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.Locale;
import org.getopentest.base.TestAction;

public class CalculateAge extends TestAction {

    @Override
    public void run() {
        // This is how we read arguments that were passed to the test action
        String birthDateString = this.readStringArgument("birthDate");

        try {
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd", Locale.ENGLISH);
            LocalDate birthDate = LocalDate.parse(birthDateString, formatter);
            Period age = Period.between(birthDate, LocalDate.now());

            // We are writing the output value "years", which can be accessed
            // from the test using the syntax $output.years
            this.writeOutput("years", age.getYears());
        } catch (DateTimeParseException exc) {
            // We catch this exception and rethrow using a friendlier message
            // to make it earsier for testers to understand the issue
            throw new RuntimeException(String.format(
                    "Failed to parse date \"%s\". Please use the format YYYY-MM-DD.",
                    birthDateString), exc);
        }
    }
}
